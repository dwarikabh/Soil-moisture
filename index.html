<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soil Moisture Calculator</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function SoilMoistureApp() {
      const [studyInfo, setStudyInfo] = useState({
        studyName: '',
        year: new Date().getFullYear(),
        samplingDate: new Date().toISOString().split('T')[0]
      });
      const [ovenInfo, setOvenInfo] = useState({ ovenInDate:'', ovenInTime:'', ovenOutDate:'', ovenOutTime:'' });
      const [samples, setSamples] = useState([]);
      const [showReminder, setShowReminder] = useState(false);
      const [timeRemaining, setTimeRemaining] = useState('');

      useEffect(() => {
        if(ovenInfo.ovenInDate && ovenInfo.ovenInTime) {
          const interval = setInterval(()=>{
            const ovenDT = new Date(`${ovenInfo.ovenInDate}T${ovenInfo.ovenInTime}`);
            const target = new Date(ovenDT.getTime() + 48*60*60*1000);
            const now = new Date();
            const diff = target - now;
            if(diff>0){
              const h=Math.floor(diff/(1000*60*60));
              const m=Math.floor((diff % (1000*60*60))/(1000*60));
              setTimeRemaining(`${h}h ${m}m remaining`);
            } else setTimeRemaining('48 hours completed - Ready to measure!');
            setShowReminder(true);
          }, 60000);
          return ()=>clearInterval(interval);
        }
      }, [ovenInfo.ovenInDate, ovenInfo.ovenInTime]);

      const addSample = ()=>setSamples([...samples, {
        id: Date.now(), trayId:'', plotNumber:'', treatment:'', soilDepth:'', depthUnit:'cm',
        cupId:'', cupWeight:'', cupFreshSoilWeight:'', cupDrySoilWeight:'', moisturePercent:''
      }]);

      const updateSample=(id, field, value)=>{
        setSamples(samples.map(s=>{
          if(s.id===id){
            const updated={...s, [field]:value};
            const cw=parseFloat(updated.cupWeight), cfw=parseFloat(updated.cupFreshSoilWeight), cdw=parseFloat(updated.cupDrySoilWeight);
            if(!isNaN(cw)&&!isNaN(cfw)&&!isNaN(cdw)){
              updated.moisturePercent = (((cfw-cdw)/ (cdw-cw))*100).toFixed(2);
            }
            return updated;
          }
          return s;
        }));
      };

      const deleteSample = id => setSamples(samples.filter(s=>s.id!==id));

      const exportToExcel = () => {
        const data = samples.map(s=>({
          'Study Name': studyInfo.studyName, 'Year':studyInfo.year, 'Sampling Date':studyInfo.samplingDate,
          'Tray ID':s.trayId, 'Plot Number':s.plotNumber, 'Treatment':s.treatment, 'Soil Depth':s.soilDepth,
          'Depth Unit':s.depthUnit, 'Cup ID':s.cupId, 'Cup Wt (g)':s.cupWeight, 'Cup+Fresh (g)':s.cupFreshSoilWeight,
          'Cup+Dry (g)':s.cupDrySoilWeight, 'Oven In': ovenInfo.ovenInDate ? `${ovenInfo.ovenInDate} ${ovenInfo.ovenInTime}`:'',
          'Oven Out': ovenInfo.ovenOutDate ? `${ovenInfo.ovenOutDate} ${ovenInfo.ovenOutTime}`:'', 'Soil Moisture (%)':''
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'SoilMoisture');
        XLSX.writeFile(wb, `SoilMoisture_${studyInfo.studyName}_${studyInfo.year}.xlsx`);
      };

      const generateEmailBody = ()=>encodeURIComponent(`Soil Moisture Data
Study: ${studyInfo.studyName}
Year: ${studyInfo.year}
Sampling Date: ${studyInfo.samplingDate}
Total Samples: ${samples.length}
Oven In: ${ovenInfo.ovenInDate} ${ovenInfo.ovenInTime}
Oven Out: ${ovenInfo.ovenOutDate} ${ovenInfo.ovenOutTime}
Please find the Excel file attached.`);

      return (
        <div className="max-w-3xl mx-auto p-4">
          <h1 className="text-3xl font-bold text-green-800 mb-6 text-center">Soil Moisture Calculator</h1>

          {/* Study Info */}
          <div className="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 className="font-semibold text-lg mb-2">Study Info</h2>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <input type="text" value={studyInfo.studyName} placeholder="Study Name"
                className="border p-2 rounded" onChange={e=>setStudyInfo({...studyInfo, studyName:e.target.value})}/>
              <input type="number" value={studyInfo.year} className="border p-2 rounded" onChange={e=>setStudyInfo({...studyInfo, year:e.target.value})}/>
              <input type="date" value={studyInfo.samplingDate} className="border p-2 rounded" onChange={e=>setStudyInfo({...studyInfo, samplingDate:e.target.value})}/>
            </div>
          </div>

          {/* Oven Info */}
          <div className="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 className="font-semibold text-lg mb-2">Oven Info</h2>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
              <input type="date" value={ovenInfo.ovenInDate} className="border p-2 rounded" onChange={e=>setOvenInfo({...ovenInfo, ovenInDate:e.target.value})}/>
              <input type="time" value={ovenInfo.ovenInTime} className="border p-2 rounded" onChange={e=>setOvenInfo({...ovenInfo, ovenInTime:e.target.value})}/>
              <input type="date" value={ovenInfo.ovenOutDate} className="border p-2 rounded" onChange={e=>setOvenInfo({...ovenInfo, ovenOutDate:e.target.value})}/>
              <input type="time" value={ovenInfo.ovenOutTime} className="border p-2 rounded" onChange={e=>setOvenInfo({...ovenInfo, ovenOutTime:e.target.value})}/>
            </div>
            {showReminder && <div className="reminder mt-2 p-2 bg-yellow-100 text-yellow-800 rounded">‚è∞ {timeRemaining}</div>}
          </div>

          {/* Samples */}
          <div className="bg-white rounded-lg shadow-md p-4 mb-6">
            <div className="flex justify-between mb-2 items-center">
              <h2 className="font-semibold text-lg">Samples</h2>
              <button className="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700" onClick={addSample}>Add Sample</button>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-100">
                  <tr>
                    <th>Tray ID</th><th>Plot #</th><th>Treatment</th><th>Depth</th><th>Unit</th>
                    <th>Cup ID</th><th>Cup Wt</th><th>Cup+Fresh</th><th>Cup+Dry</th><th>Moisture %</th><th>Del</th>
                  </tr>
                </thead>
                <tbody>
                  {samples.map(s=>(
                    <tr key={s.id} className="hover:bg-gray-50">
                      <td><input value={s.trayId} onChange={e=>updateSample(s.id,'trayId',e.target.value)} className="border p-1 rounded w-full"/></td>
                      <td><input value={s.plotNumber} onChange={e=>updateSample(s.id,'plotNumber',e.target.value)} className="border p-1 rounded w-full"/></td>
                      <td><input value={s.treatment} onChange={e=>updateSample(s.id,'treatment',e.target.value)} className="border p-1 rounded w-full"/></td>
                      <td><input value={s.soilDepth} onChange={e=>updateSample(s.id,'soilDepth',e.target.value)} className="border p-1 rounded w-full"/></td>
                      <td>
                        <select value={s.depthUnit} onChange={e=>updateSample(s.id,'depthUnit',e.target.value)} className="border p-1 rounded w-full">
                          <option>cm</option><option>in</option>
                        </select>
                      </td>
                      <td><input value={s.cupId} onChange={e=>updateSample(s.id,'cupId',e.target.value)} className="border p-1 rounded w-full"/></td>
                      <td><input value={s.cupWeight} onChange={e=>updateSample(s.id,'cupWeight',e.target.value)} className="border p-1 rounded w-full"/></td>
                      <td><input value={s.cupFreshSoilWeight} onChange={e=>updateSample(s.id,'cupFreshSoilWeight',e.target.value)} className="border p-1 rounded w-full"/></td>
                      <td><input value={s.cupDrySoilWeight} onChange={e=>updateSample(s.id,'cupDrySoilWeight',e.target.value)} className="border p-1 rounded w-full bg-yellow-50"/></td>
                      <td className="font-semibold text-green-700">{s.moisturePercent}</td>
                      <td><button className="text-red-600 hover:text-red-800" onClick={()=>deleteSample(s.id)}>X</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Export Buttons */}
          {samples.length>0 && (
            <div className="flex flex-col sm:flex-row gap-2 mb-6">
              <button className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" onClick={exportToExcel}>Export Excel</button>
              <a className="bg-gray-600 text-white px-4 py-2 rounded text-center hover:bg-gray-700" href={`mailto:?subject=Soil Moisture Data&body=${generateEmailBody()}`}>Email Data</a>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<SoilMoistureApp />);
  </script>
</body>
</html>
